<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div id="header" class="mb-6"></div>

  <main class="max-w-4xl mx-auto p-4">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-xl font-semibold">League Calendar</h1>

      <!-- Button that opens the modal form -->
      <button
        id="addTeeTimeBtn"
        class="inline-flex items-center gap-2 px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
        aria-haspopup="dialog"
        aria-controls="teeTimeModal"
      >
        + Add Tee Time
      </button>
    </div>

    <!-- Responsive wrapper for the embedded Google Calendar -->
    <div class="bg-white rounded shadow overflow-hidden">
      <div class="relative" style="padding-top:56.25%; height:0; overflow:hidden; min-height:28.125rem;">
        <iframe
          src="https://calendar.google.com/calendar/embed?height=450&wkst=1&ctz=America%2FLos_Angeles&showPrint=0&showTz=0&showTitle=0&src=aW5mby50aGVhbWF0ZXVyc3RvdXJAZ21haWwuY29t&color=%23039be5"
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
          frameborder="0"
          scrolling="no"
          aria-label="League Calendar"
        ></iframe>
      </div>
    </div>
  </main>

  <div id="footer"></div>

  <!-- Modal (hidden by default) -->
  <div id="teeTimeModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4 py-6" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="bg-white rounded-lg w-full max-w-lg p-6 shadow-lg">
      <div class="flex items-start justify-between mb-4">
        <h2 id="modalTitle" class="text-lg font-semibold">Add Tee Time</h2>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700" aria-label="Close modal">&times;</button>
      </div>

      <form id="teeTimeForm" class="space-y-3" autocomplete="off">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">Date</label>
            <input name="date" id="date" type="date" required class="mt-1 block w-full rounded border-gray-300 px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Time</label>
            <input name="time" id="time" type="time" required class="mt-1 block w-full rounded border-gray-300 px-3 py-2" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Course</label>
          <input name="course" id="course" type="text" required class="mt-1 block w-full rounded border-gray-300 px-3 py-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Owner</label>
          <input name="owner" id="owner" type="text" required class="mt-1 block w-full rounded border-gray-300 px-3 py-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Open spots</label>
          <input name="openSpots" id="openSpots" type="number" min="0" step="1" required class="mt-1 block w-full rounded border-gray-300 px-3 py-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Notes <span class="text-xs text-gray-500">(max 100 chars)</span></label>
          <textarea name="notes" id="notes" rows="3" maxlength="100" class="mt-1 block w-full rounded border-gray-300 px-3 py-2" placeholder="Optional notes (max 100 characters)"></textarea>
          <div id="notesCount" class="mt-1 text-sm text-gray-500">0 / 100</div>
        </div>

        <div class="flex items-center justify-between">
          <div id="formStatus" class="text-sm text-gray-600" aria-live="polite"></div>
          <div class="flex gap-2">
            <button type="button" id="cancelBtn" class="px-3 py-2 rounded border">Cancel</button>
            <button type="submit" id="submitBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    const teeEndpoint = 'https://script.google.com/macros/s/AKfycbybc_LOzij5K8wS9J_HrOAWMWGBH4P2r2y17JqvQ7gdNOGV_pSiFnTGs3yj2ja1gcrE/exec';
    const NOTES_MAX = 100;

    // DOM references
    const addBtn = document.getElementById('addTeeTimeBtn');
    const modal = document.getElementById('teeTimeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const form = document.getElementById('teeTimeForm');
    const statusEl = document.getElementById('formStatus');
    const submitBtn = document.getElementById('submitBtn');
    const notesEl = document.getElementById('notes');
    const notesCountEl = document.getElementById('notesCount');

    function openModal() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      statusEl.textContent = '';
      setTimeout(() => document.getElementById('date')?.focus(), 50);
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      form.reset();
      statusEl.textContent = '';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
      updateNotesCount();
      addBtn.focus();
    }

    addBtn?.addEventListener('click', openModal);
    closeModalBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
      if ((e.key === 'Escape' || e.key === 'Esc') && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    function updateNotesCount() {
      const len = (notesEl.value || '').length;
      notesCountEl.textContent = `${len} / ${NOTES_MAX}`;
      if (len >= NOTES_MAX) {
        notesCountEl.classList.add('text-red-600');
      } else {
        notesCountEl.classList.remove('text-red-600');
      }
    }

    notesEl?.addEventListener('input', (e) => {
      if (notesEl.value.length > NOTES_MAX) {
        notesEl.value = notesEl.value.slice(0, NOTES_MAX);
      }
      updateNotesCount();
    });

    updateNotesCount();

    function formatDateMMDDYYYY(d) {
      if (!d && d !== 0) return '';
      // If already a Date object
      let dt = d instanceof Date ? d : null;
      if (!dt) {
        // Try to parse common string formats safely
        // Accept ISO (YYYY-MM-DD or YYYY/MM/DD) or other parseable inputs
        const iso = String(d).trim();
        const m = iso.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
        if (m) {
          const yyyy = m[1];
          const mm = m[2].padStart(2,'0');
          const dd = m[3].padStart(2,'0');
          return `${mm}-${dd}-${yyyy}`;
        }
        dt = new Date(d);
        if (isNaN(dt)) {
          // unable to parse, return original string to avoid losing data
          return iso;
        }
      }
      const mm = String(dt.getMonth() + 1).padStart(2, '0');
      const dd = String(dt.getDate()).padStart(2, '0');
      const yyyy = dt.getFullYear();
      return `${mm}-${dd}-${yyyy}`;
    }

    // Build and send GET request using URLSearchParams (matches your example)
    function postTeetimeViaGet(item) {
      const params = new URLSearchParams({
        action: 'append',
        id: item.id || '',
        type: item.type || '',
        date: item.date || '',
        year: item.year || '',
        month: item.month || '',
        day: item.day || '',
        course: item.course || '',
        time: item.time || '',
        owner: item.owner || '',
        total_players: item.total_players || '',
        remaining_spots: item.remaining_spots || '',
        players: Array.isArray(item.players) ? item.players.join(';') : (item.players || ''),
        notes: item.notes || '',
        submittedAt: item.submittedAt || ''
      });
      const url = teeEndpoint + '?' + params.toString();
      return fetch(url, { method: 'GET', mode: 'cors' })
        .then(r => r.json())
        .catch(err => ({ ok: false, error: String(err) }));
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.classList.remove('text-red-600', 'text-green-600');
      statusEl.textContent = 'Sending...';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending…';

      // Collect values and compute date parts
      const dateVal = document.getElementById('date').value || '';
      let year = '', month = '', day = '';
      if (dateVal) {
        const d = new Date(dateVal + 'T00:00:00'); // ensure no timezone shift for parts
        if (!isNaN(d.getTime())) {
          year = String(d.getFullYear());
          month = String(d.getMonth() + 1);
          day = String(d.getDate());
        }
      }

      const notesTrimmed = (document.getElementById('notes').value || '').slice(0, NOTES_MAX);

      const item = {
        id: generateId(),
        type: 'teetime',
        date: formatDateMMDDYYYY(dateVal),
        year,
        month,
        day,
        course: document.getElementById('course').value || '',
        time: document.getElementById('time').value || '',
        owner: document.getElementById('owner').value || '',
        remaining_spots: String(Number(document.getElementById('openSpots').value || 0)),
        notes: notesTrimmed,
        submittedAt: new Date().toISOString()
      };

      try {
        const json = await postTeetimeViaGet(item);
        if (json && json.success === true) {
          statusEl.textContent = 'Saved ✓';
          statusEl.classList.add('text-green-600');
          setTimeout(closeModal, 800);
        } else {
          // server responded but didn't return success
          statusEl.textContent = json && json.error ? `Error: ${json.error}` : 'Saved (unknown response)';
          statusEl.classList.add('text-red-600');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      } catch (err) {
        console.error('Failed to send tee time:', err);
        statusEl.textContent = 'Error saving. Try again.';
        statusEl.classList.add('text-red-600');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });

    function generateId() {
      const date = new Date(dateVal + 'T00:00:00')
      return 'web-' + String(date.getFullYear()) + '-' + String(date.getMonth() + 1) + '-' + String(date.getDay()) + '-' + Math.floor(Math.random() * 1000);
    }

    // load header/footer partials
    async function loadPartial(id, file) {
      const res = await fetch(file);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;

      if (id === "header") {
        const toggleButton = document.getElementById("menu-toggle");
        const menu = document.getElementById("mobile-menu");

        toggleButton?.addEventListener("click", (e) => {
          e.stopPropagation();
          menu?.classList.toggle("hidden");
        });

        document.addEventListener("click", (e) => {
          if (!menu?.contains(e.target) && !toggleButton?.contains(e.target)) {
            menu?.classList.add("hidden");
          }
        });
      }
    }

    loadPartial("header", "./shared/header.html");
    loadPartial("footer", "./shared/footer.html");
  </script>
</body>
</html>
