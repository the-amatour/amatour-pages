<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mobile/input fixes: ensure visible borders and scrollable modal content -->
  <style>
    /* Ensure inputs show borders on mobile (iOS/Android) */
    input[type="date"],
    input[type="time"],
    input[type="text"],
    input[type="number"],
    textarea {
      -webkit-appearance: none;
      appearance: none;
      background-clip: padding-box;
      background-color: #fff;
    }

    /* Hide certain inner controls to avoid visual glitches */
    input[type="date"]::-webkit-clear-button,
    input[type="date"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-clear-button,
    input[type="time"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      display: none;
    }

    /* Modal dialog scroll area */
    .modal-dialog {
      max-height: calc(100vh - 3.5rem);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body class="antialiased bg-gray-50 text-gray-900">
  <header id="header" class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">League Calendar</h1>
      <button id="addTeeTimeBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+ Add Tee Time</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Calendar embed -->
    <div class="bg-white rounded shadow overflow-hidden mb-6">
      <div class="relative" style="padding-top:56.25%; height:0; overflow:hidden; min-height:37.5rem;">
        <iframe
          src="https://calendar.google.com/calendar/embed?height=450&wkst=1&ctz=America%2FLos_Angeles&showPrint=0&showTz=0&showTitle=0&src=aW5mby50aGVhbWF0ZXVyc3RvdXJAZ21haWwuY29t&color=%23039be5"
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
          frameborder="0"
          scrolling="no"
          aria-label="League Calendar"
        ></iframe>
      </div>
    </div>

    <!-- Page content placeholder -->
    <section>
      <p class="text-sm text-gray-600">View and add tee times using the form.</p>
    </section>
  </main>

  <!-- Modal (hidden by default) -->
  <div id="teeTimeModal" class="hidden fixed inset-0 z-50 flex items-start justify-center p-4 bg-black/40" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-dialog w-full max-w-lg bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="p-6">
        <div class="flex items-start justify-between mb-4">
          <h2 id="modalTitle" class="text-lg font-semibold">Add Tee Time</h2>
          <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700" aria-label="Close modal">&times;</button>
        </div>

        <form id="teeTimeForm" class="space-y-3 modal-content" autocomplete="off">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input name="date" id="date" type="date" required
                class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Time</label>
              <input name="time" id="time" type="time" required
                class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Course</label>
            <input name="course" id="course" type="text" required
              class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Owner (email)</label>
            <input name="owner" id="owner" type="email" required
              class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Open spots</label>
            <input name="openSpots" id="openSpots" type="number" min="0" step="1" required
              class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Notes <span class="text-xs text-gray-500">(max 200 chars)</span></label>
            <textarea name="notes" id="notes" rows="4" maxlength="200"
              class="mt-1 block w-full rounded border border-gray-300 bg-white px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional notes (max 200 characters)"></textarea>
            <div id="notesCount" class="mt-1 text-sm text-gray-500">0 / 200</div>
          </div>

          <div class="flex items-center justify-between">
            <div id="formStatus" class="text-sm text-gray-600" aria-live="polite"></div>
            <div class="flex gap-2">
              <button type="button" id="cancelBtn" class="px-3 py-2 rounded border">Cancel</button>
              <button type="submit" id="submitBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Submit</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-4 py-6 text-sm text-gray-500">
    &copy; <span id="year"></span> League
  </footer>

  <script>
    // Configuration: set to your Apps Script web app GET endpoint that appends rows
    const teeEndpoint = 'https://script.google.com/macros/s/AKfycbybc_LOzij5K8wS9J_HrOAWMWGBH4P2r2y17JqvQ7gdNOGV_pSiFnTGs3yj2ja1gcrE/exec';

    // Utility: generate a simple unique id
    function generateId() {
      const t = Date.now().toString(36);
      const r = Math.random().toString(36).slice(2,8);
      return `${t}-${r}`;
    }

    // Today's date at local midnight and useful formats
    (function setTodayDefaults(){
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const isoDate = `${yyyy}-${mm}-${dd}`; // input[type=date] value
      document.getElementById('date').value = isoDate;
      document.getElementById('year') && (document.getElementById('year').textContent = yyyy);
    })();

    // Format helper MM-DD-YYYY
    function formatDateMMDDYYYY(d) {
      if (!d && d !== 0) return '';
      let dt = d instanceof Date ? d : null;
      if (!dt) {
        const s = String(d).trim();
        const m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
        if (m) {
          const yyyy = m[1];
          const mm = m[2].padStart(2,'0');
          const dd = m[3].padStart(2,'0');
          return `${mm}-${dd}-${yyyy}`;
        }
        dt = new Date(d);
        if (isNaN(dt)) return s;
      }
      const mm = String(dt.getMonth() + 1).padStart(2, '0');
      const dd = String(dt.getDate()).padStart(2, '0');
      const yyyy = dt.getFullYear();
      return `${mm}-${dd}-${yyyy}`;
    }

    // POST via GET endpoint matching your existing server-side doGet append handler
    function postTeetimeViaGet(item) {
      const params = new URLSearchParams({
        action: 'append',
        id: item.id || '',
        type: item.type || '',
        date: item.date || '',
        year: item.year || '',
        month: item.month || '',
        day: item.day || '',
        course: item.course || '',
        time: item.time || '',
        owner: item.owner || '',
        total_players: item.total_players || '',
        remaining_spots: item.remaining_spots || '',
        players: Array.isArray(item.players) ? item.players.join(';') : (item.players || ''),
        notes: item.notes || '',
        submittedAt: item.submittedAt || '',
        isAdded: item.isAdded || 'FALSE'
      });
      const url = teeEndpoint + '?' + params.toString();
      return fetch(url, { method: 'GET', mode: 'cors' })
        .then(r => r.json())
        .catch(err => ({ ok: false, error: String(err) }));
    }

    // Modal helpers
    function openModal() {
      const modal = document.getElementById('teeTimeModal');
      if (!modal) return;
      modal.classList.remove('hidden');
      document.documentElement.classList.add('overflow-hidden');
      document.body.classList.add('overflow-hidden');
      const first = modal.querySelector('input,textarea,select,button');
      if (first) first.focus();
    }
    function closeModal() {
      const modal = document.getElementById('teeTimeModal');
      if (!modal) return;
      modal.classList.add('hidden');
      document.documentElement.classList.remove('overflow-hidden');
      document.body.classList.remove('overflow-hidden');
    }
    document.getElementById('addTeeTimeBtn')?.addEventListener('click', openModal);
    document.getElementById('cancelBtn')?.addEventListener('click', closeModal);
    document.getElementById('closeModalBtn')?.addEventListener('click', closeModal);
    document.getElementById('teeTimeModal')?.addEventListener('click', function(e){
      if (e.target === this) closeModal();
    });

    // Notes counter
    const notesEl = document.getElementById('notes');
    const notesCountEl = document.getElementById('notesCount');
    const NOTES_MAX = 100;
    function updateNotesCount() {
      const len = (notesEl.value || '').length;
      notesCountEl.textContent = `${len} / ${NOTES_MAX}`;
      if (len >= NOTES_MAX) notesCountEl.classList.add('text-red-600'); else notesCountEl.classList.remove('text-red-600');
    }
    notesEl?.addEventListener('input', () => {
      if (notesEl.value.length > NOTES_MAX) notesEl.value = notesEl.value.slice(0, NOTES_MAX);
      updateNotesCount();
    });
    updateNotesCount();

    // Form submit
    const form = document.getElementById('teeTimeForm');
    const statusEl = document.getElementById('formStatus');
    const submitBtn = document.getElementById('submitBtn');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.classList.remove('text-red-600', 'text-green-600');
      statusEl.textContent = 'Sending...';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending…';

      try {
        const dateVal = document.getElementById('date').value;
        const timeVal = document.getElementById('time').value;
        const d = new Date(dateVal);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1);
        const day = String(d.getDate());

        const item = {
          id: generateId(),
          type: 'teetime',
          date: formatDateMMDDYYYY(dateVal),
          year: String(year),
          month: month,
          day: day,
          course: document.getElementById('course').value || '',
          time: timeVal || '',
          owner: document.getElementById('owner').value || '',
          remaining_spots: document.getElementById('openSpots').value || '',
          notes: document.getElementById('notes').value || '',
          submittedAt: new Date().toISOString(),
          isAdded: 'FALSE'
        };

        const result = await postTeetimeViaGet(item);
        if (result && result.success) {
          statusEl.textContent = 'Saved ✓';
          statusEl.classList.add('text-green-600');
          setTimeout(() => { closeModal(); }, 800);
        } else {
          statusEl.textContent = result && result.error ? `Error: ${result.error}` : 'Save failed';
          statusEl.classList.add('text-red-600');
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Save failed';
        statusEl.classList.add('text-red-600');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });
  </script>
</body>
</html>