<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Details | The Amatour</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="header"></div>
  <main class="max-w-5xl mx-auto px-6 py-10">
    <div id="eventHeader" class="mb-10"></div>
    <div id="eventDetails"></div>
  </main>
  <div id="footer"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const slug = params.get("event");

    Promise.all([
      fetch("./scheduling/events.json").then(res => res.json()),
      fetch("./statistics/individual.json").then(res => res.json())
    ]).then(([events, players]) => {
      const event = events.find(e => e.slug === slug);
      if (!event) {
        document.getElementById("eventHeader").innerHTML = `<p class='text-red-600'>Event not found.</p>`;
        return;
      }

      const eventDate = new Date(event.date);
      const now = new Date();
      const isPast = eventDate < now;

      document.getElementById("eventHeader").innerHTML = `
        <h1 class="text-3xl font-bold text-indigo-700 mb-2">${event.event_name}</h1>
        <p class="text-gray-600 text-sm">${event.date} | ${event.venue}</p>
        <p class="text-sm text-gray-500 mt-2">${event.description}</p>
      `;

      const details = document.getElementById("eventDetails");

      if (!isPast) {
        details.innerHTML = `
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-indigo-600 mb-4">Event Info</h2>
            <ul class="text-gray-700 text-sm space-y-2">
              <li><strong>Entry Fee:</strong> $${event.entry_fee}</li>
              <li><strong>Par:</strong> ${event.par}</li>
              <li><strong>Winnings Total:</strong> $${event.winnings_total}</li>
              <li><strong>Tees (Men):</strong> ${event.tee_box_m} | ${event.course_rating_m} / ${event.slope_rating_m} | ${event.total_yardage_m} yds</li>
              <li><strong>Tees (Women):</strong> ${event.tee_box_w} | ${event.course_rating_w} / ${event.slope_rating_w} | ${event.total_yardage_w} yds</li>
              <li><strong>Tee Times:</strong> ${event.tee_times.length ? event.tee_times.join(", ") : "TBD"}</li>
              <li><strong>Rules:</strong> <a href="./rules-and-regulations" class="text-indigo-600 underline">View Rules and Regulations</a></li>
            </ul>

            <div class="mt-6">
              <h3 class="text-lg font-semibold mb-2">Registered Participants</h3>
              <ul class="list-disc list-inside text-sm text-gray-700">
                ${event.participants.length ? event.participants.map(p => `<li>${p}</li>`).join("") : "<li>None yet</li>"}
              </ul>
            </div>

            <form class="mt-6 space-y-4" onsubmit="submitRegistration(event)">
              <label class="block">
                <span class="text-gray-700 text-sm">Register (select your name)</span>
                <select id="nameSelect" required class="mt-1 block w-full rounded border border-gray-300 px-3 py-2">
                  <option value="" disabled selected>Select a name</option>
                </select>
              </label>
              <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Register</button>
            </form>
          </div>
        `;

        // Populate dropdown
        const allNames = new Set();
        players.forEach(p => allNames.add(p.name));
        const nameSelect = document.getElementById("nameSelect");
        Array.from(allNames).sort().forEach(name => {
          nameSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });

      } else {
        const pastPlayers = players.filter(p => p.events.some(e => e.slug === slug));

        details.innerHTML = `
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-indigo-600 mb-4">Scores</h2>
            ${pastPlayers.length ? pastPlayers.map(player => {
              const eventData = player.events.find(e => e.slug === slug);
              const scoreHTML = eventData.holes.map((score, i) => `<td class="px-2 py-1 border text-center text-sm">${score}</td>`).join("");
              return `
                <div class="mb-6">
                  <h3 class="text-lg font-semibold">${player.name}</h3>
                  <table class="min-w-full mt-2 mb-1 text-sm text-left text-gray-700 border border-gray-300">
                    <thead class="bg-gray-100 text-xs uppercase tracking-wider text-gray-600">
                      <tr>
                        ${eventData.holes.map((_, i) => `<th class="px-2 py-1 border text-center">${i + 1}</th>`).join("")}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>${scoreHTML}</tr>
                    </tbody>
                  </table>
                  <p class="text-sm text-gray-600">Gross: <strong>${eventData.gross}</strong> | Net: <strong>${eventData.net}</strong></p>
                </div>
              `;
            }).join("") : "<p>No scores submitted.</p>"}
          </div>
        `;
      }
    });

    function submitRegistration(e) {
      e.preventDefault();
      const name = document.getElementById("nameSelect").value;
      const subject = encodeURIComponent("Tournament Registration");
      const body = encodeURIComponent(`Hi! I'd like to register for the event: ${slug}\n\nName: ${name}`);
      window.location.href = `mailto:info.theamateurstour@gmail.com?subject=${subject}&body=${body}`;
    }

    async function loadPartial(id, file) {
      const res = await fetch(file);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;

      if (id === "header") {
        const toggle = document.getElementById("menu-toggle");
        const menu = document.getElementById("mobile-menu");
        if (toggle && menu) {
          toggle.addEventListener("click", () => {
            menu.classList.toggle("hidden");
          });
        }
      }
    }

    loadPartial("header", "./shared/header.html");
    loadPartial("footer", "./shared/footer.html");
  </script>
</body>
</html>
