<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 antialiased">
    <div class="w-full p-4 min-h-screen flex flex-col">
        <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 md:gap-6 mb-4">
            <div>
                <h1 class="text-lg font-semibold m-0">üèåÔ∏è‚Äç‚ôÇÔ∏è League Calendar</h1>
                <div class="mt-2 text-slate-400 text-sm flex gap-3">
                <span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-sky-400"></span>Events</span>
                <span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-300"></span>Tee times</span>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                <div class="inline-flex items-center gap-2">
                    <button id="prevBtn" class="px-2 py-2 bg-slate-800 rounded text-sm">‚Äπ</button>
                    <button id="todayBtn" class="px-3 py-2 bg-slate-800 rounded text-sm">Today</button>
                    <button id="nextBtn" class="px-2 py-2 bg-slate-800 rounded text-sm">‚Ä∫</button>
                </div>
                <div class="inline-flex rounded-lg bg-slate-800 p-1" role="tablist" aria-label="View">
                    <button id="monthBtn" class="px-3 py-2 text-sm rounded bg-emerald-400 text-emerald-900 font-medium" role="tab" aria-selected="true">Month</button>
                    <button id="weekBtn" class="px-3 py-2 text-sm rounded text-slate-200" role="tab" aria-selected="false">Week</button>
                </div>
                <select id="courseSelect" class="ml-0 sm:ml-2 px-3 py-2 bg-slate-800 border border-slate-700 rounded text-sm">
                    <option value="all">All courses</option>
                </select>
            </div>
        </header>

        <div id="rangeLabel" class="mb-3 font-semibold"></div>

        <main class="flex-1 overflow-auto">
            <div id="calendarRoot" class="w-full h-full"></div>
        </main>
    </div>

    <dialog id="detailModal" class="rounded-lg">
        <div class="w-[min(720px,95vw)] bg-slate-800 text-slate-100 rounded-lg overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700">
            <div id="modalTitle" class="font-semibold"></div>
            <button type="button" class="px-2 py-1 rounded bg-slate-700" onclick="document.getElementById('detailModal').close()">‚úï</button>
            </div>
            <div id="modalBody" class="p-4 text-sm"></div>
            <div id="modalActions" class="p-3 border-t border-slate-700 flex justify-end gap-2"></div>
        </div>
    </dialog>

  <!-- Create event modal -->
    <dialog id="createModal" class="rounded-lg">
        <form id="createForm" class="w-[min(720px,95vw)] bg-slate-800 text-slate-100 rounded-lg overflow-hidden p-4">
            <h3 class="text-lg font-semibold mb-2">Create Event</h3>
            <input name="title" placeholder="Title" class="w-full mb-2 px-3 py-2 bg-slate-900 border border-slate-700 rounded" required />
            <select name="courseId" class="w-full mb-2 px-3 py-2 bg-slate-900 border border-slate-700 rounded"></select>
            <div class="flex gap-2 mb-2">
            <input name="date" type="date" class="flex-1 px-3 py-2 bg-slate-900 border border-slate-700 rounded" required />
            <input name="start" type="time" class="w-30 px-3 py-2 bg-slate-900 border border-slate-700 rounded" required />
            </div>
            <div class="flex gap-2 mb-2">
            <select name="type" class="px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                <option value="event">Event</option>
                <option value="teetime">Tee time</option>
            </select>
            <input name="capacity" type="number" min="1" placeholder="Capacity" class="px-3 py-2 bg-slate-900 border border-slate-700 rounded" />
            </div>
            <div class="flex justify-end gap-2">
            <button type="button" id="cancelCreate" class="px-3 py-2 rounded bg-slate-700">Cancel</button>
            <button type="submit" class="px-3 py-2 rounded bg-emerald-500 text-emerald-900">Create</button>
            </div>
        </form>
    </dialog>

  <script>
    const teeEndpoint = 'https://script.google.com/macros/s/AKfycbybc_LOzij5K8wS9J_HrOAWMWGBH4P2r2y17JqvQ7gdNOGV_pSiFnTGs3yj2ja1gcrE/exec';
    // data placeholders
    let COURSES = [{id:'oak',name:'Oak Ridge GC'}];
    fetch('./scheduling/courses.json').then(r=>{
      if (!r.ok) throw new Error('no event.json');
      return r.json();
    }).then(data=>{
      data.forEach(c => COURSES.push({id:c.id, name:c.name}));
    });

    // fetch deployed Apps Script web app (replace DEPLOY_URL with your script's exec URL)
    fetch(teeEndpoint)
      .then(r => { if (!r.ok) throw new Error('sheet fetch failed'); return r.json(); })
      .then(rows => {
        // rows is an array of objects (headers -> values). Map into minimal-schema teetimes.
        rows.forEach(e => {
          const id = e.id || ('ts-' + Date.now() + Math.random().toString(36).slice(2,6));
          const yr = Number(e.year) || (e.date ? new Date(String(e.date)).getFullYear() : undefined);
          const mo = Number(e.month) || (e.date ? (new Date(String(e.date)).getMonth()+1) : undefined);
          const dy = Number(e.day) || (e.date ? new Date(String(e.date)).getDate() : undefined);
          const item = {
            id,
            type: (e.type && String(e.type).toLowerCase()==='event') ? 'event' : 'teetime',
            year: yr,
            month: mo,
            day: dy,
            course: e.course || e.course_name || e.courseId || '',
            time: e.time || e.start || '',
            total_players: Number(e.total_players || e.capacity || 4) || 4,
            remaining_spots: (typeof e.remaining_spots !== 'undefined') ? Number(e.remaining_spots) : (typeof e.remaining_spots === 'undefined' && e.capacity ? Number(e.capacity) : 0)
          };
          // decide where to push; we keep official events separate if type==='event'
          if (item.type === 'event') EVENTS.push(item); else TEETIMES.push(item);
        });
        populateCourses();
        render();
      })
      .catch(err => console.warn('Google Sheet fetch failed:', err));

    // Keep two arrays but items use the minimal schema described:
    // { type:'event'|'teetime', month, day, year, course, time, total_players, remaining_spots, id? }
    const EVENTS = [];
    const TEETIMES = [];

    const TZ = 'America/Los_Angeles';
    const fmt = (d, opts) => new Intl.DateTimeFormat('en-US',{timeZone:TZ,...opts}).format(new Date(d));
    // adapter to get a Date from an item (supports old start ISO and new minimal schema)
    function itemStartDate(it){
      if (!it) return new Date();
      if (it.start) return new Date(it.start);
      // new minimal schema: year, month (1-12 or 0-11?), day, time "HH:MM"
      const yr = Number(it.year);
      const mo = (typeof it.month === 'string' && it.month.length>0 && isNaN(it.month)) ? new Date(it.month + ' 1').getMonth() : Number(it.month) - 1;
      const day = Number(it.day);
      let hh = 0, mm = 0;
      if (it.time){
        const [H,M] = String(it.time).split(':').map(x=>Number(x));
        hh = isNaN(H) ? 0 : H;
        mm = isNaN(M) ? 0 : M;
      }
      if (!isNaN(yr) && !isNaN(mo) && !isNaN(day)) return new Date(yr, mo, day, hh, mm);
      return new Date();
    }
    const toDate = iso => new Date(iso);
    function isMobile(){ return typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(max-width:639px)').matches; }

    const STATE = { view:'month', refDate:new Date(), course:'all', showEvents:true, showTeeTimes:true, me:'You', isMobile:isMobile() };

    function collect(){ return [...EVENTS, ...TEETIMES].filter(i=>{
      if (STATE.course && STATE.course!=='all' && (i.course !== STATE.course && i.courseId !== STATE.course)) return false;
      if (i.type==='event' && !STATE.showEvents) return false;
      if (i.type==='teetime' && !STATE.showTeeTimes) return false;
      return true;
    }); }

    /* ---------- Month ---------- */
    function renderMonth(root){
      root.innerHTML = '';

      const year = STATE.refDate.getFullYear();
      const month = STATE.refDate.getMonth();
      const first = new Date(year, month, 1);
      const start = new Date(first); start.setDate(first.getDate() - ((first.getDay()+6)%7));
      const last = new Date(year, month+1, 0);
      const end = new Date(last); end.setDate(last.getDate() + (6 - ((last.getDay()+6)%7)));

      document.getElementById('rangeLabel').textContent = `${fmt(first,{month:'long'})} ${year}`;

      const dow = document.createElement('div');
      dow.className = 'hidden sm:grid grid-cols-7 text-slate-400 text-xs gap-0 mb-1';
      ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{ const el=document.createElement('div'); el.textContent=d; el.className='px-2'; dow.appendChild(el); });
      root.appendChild(dow);

      // grid wrapper allows horizontal scroll on small screens
      const gridWrap = document.createElement('div');
      gridWrap.className = 'overflow-x-auto pt-1';
      const grid = document.createElement('div');
      // 7-col grid on larger screens; keep 7 columns but allow each cell min-width for scrolling
      grid.className = 'grid grid-cols-7 gap-1 bg-slate-800 rounded';
      // removed gridAutoFlow='column' (it caused the grid to render as a single row)
      gridWrap.appendChild(grid);
      root.appendChild(gridWrap);

      const items = collect().filter(i=>{
        const s = itemStartDate(i);
        return s <= end && s >= start;
      });
      const itemsByDay = {};
      items.forEach(it => {
        const key = itemStartDate(it).toISOString().slice(0,10);
        (itemsByDay[key] ||= []).push(it);
      });

      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const cell = document.createElement('div');
        // Tailwind utility classes via className
        cell.className = 'bg-slate-900 min-h-[84px] p-2 flex flex-col gap-2';
        // responsive min-width: scale with viewport but clamp to usable range
        // cell.style.minWidth = 'clamp(88px, 13.5vw, 160px)'; // replaces hard 120px
        if (new Date().toDateString() === d.toDateString()) cell.classList.add('ring-2','ring-sky-500','rounded-sm');
        if (d.getMonth() !== month) cell.style.opacity = 0.6;
        // capture the date for this iteration so handlers use the correct day
        const cellDate = new Date(d);

        const dn = document.createElement('div'); dn.className='text-xs text-slate-400'; dn.textContent = String(d.getDate());
        cell.appendChild(dn);

        const key = d.toISOString().slice(0,10);
        const todays = (itemsByDay[key]||[]).slice(0, STATE.isMobile ? 2 : 3);
        todays.forEach(it=> cell.appendChild(renderChip(it)));

        const moreCount = (itemsByDay[key]?.length || 0) - todays.length;
        if (moreCount > 0){
          const m = document.createElement('div'); m.className = 'text-xs text-slate-400 cursor-pointer'; m.textContent = `+${moreCount} more`;
          // use the captured cellDate so the modal opens for the correct day
          m.addEventListener('click', (e) => { e.stopPropagation(); openDayModal(cellDate, itemsByDay[key]); });
          cell.appendChild(m);
        } else if ((itemsByDay[key]?.length || 0) === 0){
          const empty = document.createElement('div'); empty.className='text-slate-500 text-xs mt-1'; empty.textContent='‚Äî';
          cell.appendChild(empty);
        }

        grid.appendChild(cell);
        // click a day cell to create a new event (ignore clicks on chips)
        cell.addEventListener('click', (e) => {
          if (e.target.closest('.chip')) return;
          openCreateModal(cellDate);
        });
      }
    }

    function postTeetimeViaGet(item){
        const params = new URLSearchParams({
            action: 'append',
            id: item.id,
            type: item.type,
            date: item.date,
            year: item.year,
            month: item.month,
            day: item.day,
            course: item.course,
            time: item.time,
            total_players: item.total_players || '',
            remaining_spots: item.remaining_spots || '',
            players: Array.isArray(item.players) ? item.players.join(';') : (item.players || ''),
            notes: item.notes || ''
        });
        const url = teeEndpoint + '?' + params.toString();
        return fetch(url, { method: 'GET' }).then(r => r.json()).catch(err => ({ok:false,error:String(err)}));
    }

    function postTeetimeToSheet(payload) {
        const toad = '9f2b7e4a1c3d8f6b0a9e2c4d5f7a8b1c';
        const body = Object.assign({}, payload, { token: toad });
        return fetch(teeEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(r => r.json()).catch(err => ({ok:false,error:String(err)}));
    }

    /* ---------- Create event handlers ---------- */
    function openCreateModal(day){
        const modal = document.getElementById('createModal');
        const form = document.getElementById('createForm');
        form.reset();
        // populate courses select
        const sel = form.querySelector('select[name="courseId"]');
        sel.innerHTML = COURSES.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        // prefill date
        form.querySelector('input[name="date"]').value = day.toISOString().slice(0,10);
        modal.showModal();
    }
    document.getElementById('cancelCreate').onclick = ()=> document.getElementById('createModal').close();
    document.getElementById('createForm').onsubmit = function(e){
        e.preventDefault();
        const f = e.target;
        const data = Object.fromEntries(new FormData(f).entries());
        // robust date parsing
        const dateVal = (f.querySelector('input[name="date"]') || {}).value || data.date || '';
        const dateObj = dateVal ? new Date(dateVal + 'T00:00') : new Date();
        const yr = dateObj.getFullYear();
        const mo = dateObj.getMonth() + 1;
        const dy = dateObj.getDate();
        const id = 'evt-' + Date.now();
        const item = {
          id,
          type: data.type || 'teetime',
          date: `${yr}-${String(mo).padStart(2,'0')}-${String(dy).padStart(2,'0')}`,
          year: yr,
          month: mo,
          day: dy,
          course: data.courseId || data.course || '',
          time: data.start || data.time || '',
          total_players: parseInt(data.capacity) || 4,
          remaining_spots: parseInt(data.capacity) || 4,
          players: []
        };

        const submitBtn = f.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;

        postTeetimeViaGet(item).then(resp => {
          if (resp && resp.ok && resp.id) item.id = resp.id;
          if (item.type === 'event') EVENTS.push(item); else TEETIMES.push(item);
          populateCourses(); render();
          document.getElementById('createModal').close();
        }).catch(err => {
          console.warn('Sheet post failed, saving locally', err);
          if (item.type === 'event') EVENTS.push(item); else TEETIMES.push(item);
          populateCourses(); render();
          document.getElementById('createModal').close();
        }).finally(()=>{ if (submitBtn) submitBtn.disabled = false; });
    };

    /* ---------- Navigation handlers ---------- */
    document.getElementById('prevBtn').onclick = () => {
      if (STATE.view === 'month') {
        STATE.refDate.setMonth(STATE.refDate.getMonth() - 1);
      } else {
        STATE.refDate.setDate(STATE.refDate.getDate() - 7);
      }
      render();
    };

    document.getElementById('nextBtn').onclick = () => {
      if (STATE.view === 'month') {
        STATE.refDate.setMonth(STATE.refDate.getMonth() + 1);
      } else {
        STATE.refDate.setDate(STATE.refDate.getDate() + 7);
      }
      render();
    };
    document.getElementById('todayBtn').onclick = () => { STATE.refDate = new Date(); render();
    };

    /* ---------- Load events from event.json (league events) ---------- */
    fetch('./scheduling/events.json').then(r=>{
      if (!r.ok) throw new Error('no event.json');
      return r.json();
    }).then(data=>{
      // expect either an array of objects or { events: [...] }
      const arr = Array.isArray(data) ? data : (Array.isArray(data.events) ? data.events : []);
      arr.forEach(e=>{
        // map incoming fields into the minimal schema; supports various source shapes
        const mapped = {
          id: e.id || ('evt-'+Date.now()+Math.random().toString(36).slice(2,6)),
          type: e.type || 'event',
          year: e.year || (e.start_time ? new Date(e.start_time).getFullYear() : (e.date ? new Date(e.date).getFullYear() : undefined)),
          month: e.month || (e.start_time ? (new Date(e.start_time).getMonth()+1) : (e.date ? (new Date(e.date).getMonth()+1) : undefined)),
          day: e.day || (e.start_time ? new Date(e.start_time).getDate() : (e.date ? new Date(e.date).getDate() : undefined)),
          course: e.course || e.course_id || e.venue || '',
          time: e.time || e.start_time || e.start || '',
          total_players: e.total_players || e.capacity || 0,
          remaining_spots: (typeof e.remaining_spots !== 'undefined') ? e.remaining_spots : (e.capacity ? e.capacity : 0)
        };
        EVENTS.push(mapped);
      });
      populateCourses(); render();
    }).catch(()=>{ /* silent if missing during dev */ });


    /* ---------- Week ---------- */
    function renderWeek(root){
      root.innerHTML = '';
      const ref = new Date(STATE.refDate);
      const dowIdx = (ref.getDay()+6)%7;
      const monday = new Date(ref); monday.setDate(ref.getDate()-dowIdx);
      const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);

      document.getElementById('rangeLabel').textContent = `${fmt(monday,{month:'short',day:'numeric'})} ‚Äì ${fmt(sunday,{month:'short',day:'numeric',year:'numeric'})}`;

      const wrap = document.createElement('div'); wrap.className = 'flex gap-3';
      // time labels
      const timecol = document.createElement('div'); timecol.className = 'w-14 hidden sm:flex flex-col gap-2 text-xs text-slate-400';
      const hours = Array.from({length:10},(_,i)=>8+i);
      hours.forEach(h=>{ const t = document.createElement('div'); t.className='h-14'; t.textContent = `${String(h).padStart(2,'0')}:00`; timecol.appendChild(t); });
      wrap.appendChild(timecol);

      const colsWrap = document.createElement('div'); colsWrap.className = 'flex gap-3 overflow-x-auto';
      for(let i=0; i<7; i++) {
        // each column gets a 1/7 width but can shrink; reduce hard min-height so it doesn't cap the viewport
        const col = document.createElement('div');
        col.className = 'relative bg-slate-900 min-h-[480px] rounded flex-none w-[calc(100%/7)] min-w-[120px]';
        const day = new Date(monday); day.setDate(monday.getDate()+i);
        // optional day header
        const hdr = document.createElement('div'); hdr.className='p-2 text-sm text-slate-300 border-b border-slate-800'; hdr.textContent = `${fmt(day,{weekday:'short',month:'short',day:'numeric'})}`;
        col.appendChild(hdr);
        colsWrap.appendChild(col);
      }
      wrap.appendChild(colsWrap);
      root.appendChild(wrap);

      // place items
      const items = collect().filter(i=>{
        const s=toDate(i.start), e=toDate(i.end); return s<=sunday && e>=monday;
      });
      items.forEach(it=>{
        const s = itemStartDate(it);
        const dayIdx = (s.getDay()+6)%7;
        const col = colsWrap.children[dayIdx];
        const startMin = (s.getHours()-8)*60 + s.getMinutes();
        const endMin = (e.getHours()-8)*60 + e.getMinutes();
        // match the column min-height so slot positioning scales correctly
        const totalHeight = hours.length * 48;
        const top = Math.max(0, Math.min(totalHeight - 24, (startMin / (10*60)) * totalHeight));
        const height = Math.max(28, ((endMin - startMin) / (10*60)) * totalHeight);
        const slot = document.createElement('div'); slot.className = 'absolute left-2 right-2 rounded p-2 text-xs';
        slot.style.top = top + 'px'; slot.style.height = height + 'px';
        slot.style.background = (it.type==='event') ? 'rgba(78,168,255,0.12)' : 'rgba(249,199,79,0.10)';
        slot.style.border = (it.type==='event') ? '1px solid rgba(78,168,255,0.18)' : '1px solid rgba(249,199,79,0.18)';
        const courseName = getCourseName(it);
        slot.innerHTML = `<div class="font-semibold">${getTitle(it)}</div><div class="text-slate-400 text-[11px]">${it.time ? it.time : fmt(s,{hour:'numeric',minute:'2-digit'})} ‚Ä¢ ${courseName}</div>`;
        slot.addEventListener('click', (e) => { e.stopPropagation(); openItemModal(it); });
        col.appendChild(slot);
      });
    }

    /* ---------- UI helpers & modal ---------- */
    function renderChip(it){
        const chip = document.createElement('div'); chip.className = 'flex items-center gap-2 bg-slate-800 p-1 rounded text-sm cursor-pointer';
        const dot = document.createElement('span'); dot.className = 'w-2 h-2 rounded-full ' + (it.type==='event' ? 'bg-sky-400' : 'bg-amber-300');
        const content = document.createElement('div'); content.className = 'truncate text-xs';
        // use adapter to compute Date from minimal schema, prefer explicit item.time when present
        const s = (typeof itemStartDate === 'function') ? itemStartDate(it) : (it.start ? new Date(it.start) : new Date());
        const time = it.time ? it.time : fmt(s, {hour:'numeric', minute:'2-digit'});
        content.innerHTML = `<span class="font-medium">${it.course}</span> <span class="text-slate-400">‚Ä¢ ${time}</span>`;
        chip.appendChild(dot); chip.appendChild(content);
        chip.addEventListener('click', (e) => { e.stopPropagation(); openItemModal(it); });
        return chip;
    }

    // helper to resolve course display name from either minimal schema (course) or legacy courseId
    function getCourseName(it){
      if (!it) return '';
      if (it.course && typeof it.course === 'string' && it.course.trim()) return it.course;
      if (it.courseId){
        const c = COURSES.find(x=> x.id === it.courseId || x.id === String(it.courseId));
        if (c) return c.name;
      }
      // try matching by name/slug against COURSES
      const match = COURSES.find(x => x.name === it.course || x.id === it.course || x.slug === it.course);
      if (match) return match.name;
      return String(it.course || it.courseId || '');
    }

    // helper to resolve a display title from multiple possible source fields
    function getTitle(it){
      if (!it) return '(untitled)';
      return it.title || it.event_name || it.name || it.slug || '(untitled)';
    }

    function openDayModal(day, list) {
      const modal = document.getElementById('detailModal');
      document.getElementById('modalTitle').textContent = fmt(day,{weekday:'long',month:'long',day:'numeric'});
      const body = document.getElementById('modalBody'); body.innerHTML = '';
      (list||[]).forEach(it=>{
        const row = document.createElement('div'); row.className = 'flex items-center gap-3 p-2 hover:bg-slate-800 rounded cursor-pointer';
        const s = itemStartDate(it);
        const timeStr = it.time ? it.time : fmt(s,{hour:'numeric',minute:'2-digit'});
        row.innerHTML = `<div class="w-20 text-xs font-medium">${timeStr}</div>
          <div class="flex-1 text-sm">${getTitle(it)}</div>
          <div class="text-xs text-slate-400">${getCourseName(it)}</div>`;
        row.onclick = ()=> openItemModal(it);
        body.appendChild(row);
      });
      document.getElementById('modalActions').innerHTML = `<button class="px-3 py-1 rounded bg-slate-700" onclick="document.getElementById('detailModal').close()">Close</button>`;
      document.getElementById('detailModal').showModal();
    }

    function openItemModal(it){
      const modal = document.getElementById('detailModal');
      document.getElementById('modalTitle').textContent = getTitle(it);
      const s = itemStartDate(it);
      const e = it.end ? new Date(it.end) : new Date(s.getTime() + 60*60*1000); // default 1 hour
      const courseName = getCourseName(it);
      let html = `<div class="row"><strong>Date:</strong> ${fmt(s,{weekday:'short',month:'long',day:'numeric'})}</div>
        <div class="row"><strong>Time:</strong> ${it.time ? it.time : fmt(s,{hour:'numeric',minute:'2-digit'})} ‚Äì ${fmt(e,{hour:'numeric',minute:'2-digit'})} (${TZ})</div>
        <div class="row"><strong>Course:</strong> ${courseName}</div>`;
      if (it.type==='event' && it.notes) html += `<div class="text-sm mb-2"><strong>Notes:</strong> ${it.notes}</div>`;
      if (it.type==='teetime'){
        const left = Math.max(0,(it.capacity||4) - (it.booked?.length||0));
        html += `<div class="text-sm mb-2"><strong>Capacity:</strong> ${it.capacity||4} ‚Äî ${left>0?left+' open':'Full'}</div>`;
        html += `<div class="text-sm mb-2"><strong>Players:</strong> ${(it.booked && it.booked.length)?it.booked.join(', '):'‚Äî'}</div>`;
        if (it.waitlist?.length) html += `<div class="text-sm mb-2"><strong>Waitlist:</strong> ${it.waitlist.join(', ')}</div>`;
      }
      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('modalActions').innerHTML = `<button class="px-3 py-1 rounded bg-slate-700" onclick="document.getElementById('detailModal').close()">Close</button>`;
      modal.showModal();
    }

    /* ---------- Export ICS ---------- */
    function exportICS(){
      const items = collect();
      const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//League//Calendar//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
      items.forEach(it=>{
        const uid = it.id + '@league';
        const dtStart = toDate(it.start).toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
        const dtEnd = toDate(it.end).toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
        const course = COURSES.find(c=>c.id===it.courseId)?.name || '';
        lines.push('BEGIN:VEVENT', `UID:${uid}`, `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`, `DTSTART:${dtStart}`, `DTEND:${dtEnd}`, `SUMMARY:${(it.type==='teetime'?'Tee Time: ':'')}${it.title}`, `LOCATION:${course}`, `DESCRIPTION:${it.type==='event'?(it.notes||''):`Capacity ${it.capacity||4}`}`, 'END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob = new Blob([lines.join('\r\n')], {type:'text/calendar'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'league-calendar.ics'; a.click();
      URL.revokeObjectURL(url);
    }

    /* ---------- Wiring ---------- */
    const calendarRoot = document.getElementById('calendarRoot');
    function render(){ if (STATE.view === 'month') renderMonth(calendarRoot); else renderWeek(calendarRoot); }

    document.getElementById('monthBtn').onclick = ()=>{
      STATE.view='month';
      document.getElementById('monthBtn').classList.add('bg-emerald-400','text-emerald-900');
      document.getElementById('weekBtn').classList.remove('bg-emerald-400','text-emerald-900');
      render();
    };
    document.getElementById('weekBtn').onclick = ()=>{
      STATE.view='week';
      document.getElementById('weekBtn').classList.add('bg-emerald-400','text-emerald-900');
      document.getElementById('monthBtn').classList.remove('bg-emerald-400','text-emerald-900');
      render();
    };
    

    const select = document.getElementById('courseSelect');
    function populateCourses() { 
        select.innerHTML = '<option value="all">All courses</option>';
        COURSES.forEach(c => {
            const opt=document.createElement('option');
            opt.value=c.id;
            opt.textContent=c.name;
            select.appendChild(opt);
        }); 
    }
    select.onchange = (e)=> { STATE.course = e.target.value; render(); };

    let rto = null;
    window.addEventListener('resize', ()=>{ clearTimeout(rto); rto = setTimeout(()=>{
      const nowMobile = isMobile();
      if (nowMobile !== STATE.isMobile) STATE.isMobile = nowMobile;
      render();
    },150); });

    function initWithData({courses, events, teetimes}){
      if (courses) { COURSES.length = 0; COURSES.push(...courses); }
      if (events) { EVENTS.length = 0; EVENTS.push(...events); }
      if (teetimes) { TEETIMES.length = 0; TEETIMES.push(...teetimes); }
      populateCourses(); render();
    }

    populateCourses(); render();
    window.initCalendar = initWithData;
  </script>
</body>
</html>