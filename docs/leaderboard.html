<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard | The Amatour</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="header" class="mb-6"></div>

  <main class="max-w-4xl mx-auto px-6 py-10">
    <h1 class="text-3xl md:text-4xl font-bold mb-4">üèÜ Season Leaderboard</h1>

    <!-- üîç Search -->
    <div class="mb-6">
      <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search by Player Name</label>
      <input
        type="text"
        id="search"
        oninput="filterTableBySearch()"
        placeholder="Type a name..."
        class="w-full md:w-64 px-4 py-2 bg-white border border-gray-200 rounded-md text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
      />
    </div>

    <!-- year tabs + content inserted here -->
    <div id="leaderboardWrapper" class="mb-6">
      <div id="yearTabs" class="flex gap-2 mb-4 overflow-x-auto"></div>

      <!-- light panel matching index.html -->
      <div id="yearContent" class="bg-white text-gray-900 rounded-lg p-4 shadow-md border border-gray-200"></div>
    </div>

    <p class="text-sm text-gray-700 mb-6">
      View current rankings and participation across seasons. Click any year tab to view that year's leaderboard.
    </p>

    <!-- <div id="additionalInfo" class="text-sm text-gray-600">Leaderboard data loads from statistics/overview.json</div> -->
  </main>

  <script>
  // store entries & state so search can filter the rendered table
  let ALL_LEADERBOARD_ENTRIES = [];
  let CURRENT_LEADERBOARD_YEAR = null;
  let CURRENT_SEARCH = '';

  (function(){
    fetch('./statistics/overview.json')
      .then(r => {
        if (!r.ok) throw new Error('overview.json not found');
        const body = r.json();
        return body;
      })
      .then(data => {
        let entries = [];
        // If overview.json is grouped by year (object), flatten and annotate _year
        if (data && typeof data === 'object' && !Array.isArray(data)) {
          Object.entries(data).forEach(([key, group]) => {
            const yearKey = parseInt(String(key), 10);
            const year = isNaN(yearKey) ? null : yearKey;
            const arr = Array.isArray(group) ? group : [];
            arr.forEach(item => {
              const copy = Object.assign({}, item);
              copy._year = copy.parent ? Number(copy.parent) : (year || (copy.year ? Number(copy.year) : new Date().getFullYear()));
              entries.push(copy);
            });
          });
        } else {
          // legacy array format
          entries = Array.isArray(data) ? data.slice() : [];
          entries.forEach(e => {
            if (e.parent) {
              e._year = Number(e.parent);
            } else if (e.date) {
              const d = new Date(String(e.date));
              e._year = isNaN(d.getFullYear()) ? (e.year ? Number(e.year) : (new Date().getFullYear())) : d.getFullYear();
            } else if (e.year) {
              e._year = Number(e.year);
            } else {
              e._year = new Date().getFullYear();
            }
          });
        }
 
        // debug: log normalized entries + derived years so you can inspect what's happening
        console.debug('[leaderboard] normalized entries count:', entries.length);
        const years = Array.from(new Set(entries.map(e => Number(e._year || new Date().getFullYear())))).sort((a,b) => b - a);
        console.debug('[leaderboard] derived years:', years, 'sample entries:', entries.slice(0,6));
 
        ALL_LEADERBOARD_ENTRIES = entries;
        renderYearTabs(years, ALL_LEADERBOARD_ENTRIES);
      })
      .catch(err => {
        console.error('Failed to load leaderboard overview', err);
        const content = document.getElementById('yearContent');
        if (content) content.textContent = 'Unable to load leaderboard.';
      });

    function renderYearTabs(years, entries) {
      const tabs = document.getElementById('yearTabs');
      const content = document.getElementById('yearContent');
      if (!tabs || !content) return;
      tabs.innerHTML = '';
      content.innerHTML = '';
      if (!years.length) return;
      years.forEach((y, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.year = String(y);
        btn.className = i === 0
          ? 'px-3 py-1 rounded bg-white text-gray-900 border border-gray-200 shadow-sm whitespace-nowrap'
          : 'px-3 py-1 rounded bg-gray-50 text-gray-700 border border-gray-100 whitespace-nowrap hover:bg-gray-100';
        btn.textContent = String(y);
        btn.addEventListener('click', () => {
          // toggle visual active state
          tabs.querySelectorAll('button').forEach(b => b.className = 'px-3 py-1 rounded bg-gray-50 text-gray-700 border border-gray-100 whitespace-nowrap hover:bg-gray-100');
          btn.className = 'px-3 py-1 rounded bg-white text-gray-900 border border-gray-200 shadow-sm whitespace-nowrap';
          
          // if switching to a different year, clear search criteria
          if (CURRENT_LEADERBOARD_YEAR !== null && Number(CURRENT_LEADERBOARD_YEAR) !== Number(y)) {
            CURRENT_SEARCH = '';
            const searchInput = document.getElementById('search');
            if (searchInput) searchInput.value = '';
          }
          
          CURRENT_LEADERBOARD_YEAR = y;
          renderYearContent(y, entries, CURRENT_SEARCH);
        });
        tabs.appendChild(btn);
      });
      // render first (newest) year by default
      if (years[0] !== undefined) {
        CURRENT_LEADERBOARD_YEAR = years[0];
        renderYearContent(years[0], entries, CURRENT_SEARCH);
      }
    }

    // add optional search parameter; will filter rows by name/player
    function renderYearContent(year, entries, search){
      const content = document.getElementById('yearContent');
      if (!content) return;
      const rows = entries
        .filter(e => Number(e._year) === Number(year))
        .filter(e => {
          if (!search) return true;
          const s = String(search).toLowerCase();
          const name = String(e.name || e.player || '').toLowerCase();
          return name.includes(s);
        })
        .sort((a,b) => (b.finale_points || 0) - (a.finale_points || 0));

      if (!rows.length) {
        content.innerHTML = `<div class="text-sm text-gray-600 p-4">No entries for ${year}.</div>`;
        return;
      }

      // build table using light panel styles matching index.html
      const html = [];
      html.push('<div class="overflow-x-auto">');
      html.push('<table class="min-w-full text-sm">');

      // header
      html.push('<thead class="bg-gray-50 text-gray-700"><tr>');
      html.push('<th class="px-6 py-3 text-left text-sm font-medium">Rank</th>');
      html.push('<th class="px-6 py-3 text-left text-sm font-medium">Member</th>');
      html.push('<th class="px-6 py-3 text-left text-sm font-medium">Finale Points</th>');
      html.push('</tr></thead>');

      html.push('<tbody class="bg-white">');
      // compute ranking with tie handling: tied finale_points => "T{startRank}"
      // helper to produce a simple slug when p.slug is not provided
      const slugify = (s) => String(s || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

      let tieGroupStartRank = 1;
      rows.forEach((p, idx) => {
        const pts = Number(p.finale_points ?? 0);
        const prevPts = idx > 0 ? Number(rows[idx - 1].finale_points ?? 0) : null;
        let rankLabel;
        if (idx === 0) {
          tieGroupStartRank = 1;
          rankLabel = '1';
        } else if (pts === prevPts) {
          // same as previous -> tied with the group's starting rank
          rankLabel = 'T' + String(tieGroupStartRank);
        } else {
          tieGroupStartRank = idx + 1;
          rankLabel = String(tieGroupStartRank);
        }

        // determine player slug and URL
        const rawSlug = p.slug ? String(p.slug) : slugify(p.name || p.player || '');
        const playerUrl = `player-details.html?player=${encodeURIComponent(rawSlug)}`;
        const displayName = escapeHtml(p.name || p.player || '');

        html.push(`<tr class="border-t border-gray-100 hover:bg-gray-50">`);
        html.push(`<td class="px-6 py-3 font-semibold text-gray-900">${escapeHtml(rankLabel)}</td>`);
        html.push(`<td class="px-6 py-3 text-gray-900 font-medium"><a href="${playerUrl}" class="text-sky-600 hover:underline">${displayName}</a></td>`);
        html.push(`<td class="px-6 py-3 font-semibold text-gray-900">${p.finale_points ?? 0}</td>`);
        html.push('</tr>');
      });
      html.push('</tbody></table></div>');

      content.innerHTML = html.join('');
    }

    // search helper called by the existing oninput handler
    window.filterTableBySearch = function(){
      const input = document.getElementById('search');
      const q = input ? (input.value || '').trim() : '';
      CURRENT_SEARCH = q;
      // re-render current year with search applied
      if (CURRENT_LEADERBOARD_YEAR !== null) {
        renderYearContent(CURRENT_LEADERBOARD_YEAR, ALL_LEADERBOARD_ENTRIES, CURRENT_SEARCH);
      }
    };

    // small helper to avoid HTML injection when rendering names
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
  })();
  </script>
</body>
</html>